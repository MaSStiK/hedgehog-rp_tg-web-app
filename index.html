<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dice Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="./style.css">
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="title">
          <h1>üé≤ Dice Mini App</h1>
          <p>–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É ‚Äî –æ—Ç–ø—Ä–∞–≤–∏–º –±—Ä–æ—Å–æ–∫ –∫—É–±–∏–∫–∞ –≤ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π —á–∞—Ç —á–µ—Ä–µ–∑ –±–æ—Ç–∞.</p>
        </div>
        <div class="badge" id="tgBadge" title="–°—Ç–∞—Ç—É—Å –æ–∫—Ä—É–∂–µ–Ω–∏—è">
          <span class="dot"></span>
          <span id="envText">Telegram</span>
        </div>
      </div>

      <div class="content">
        <div class="panel result" aria-live="polite">
          <div class="left">
            <div class="label">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
            <div class="value">
              <span class="emoji">üé≤</span>
              <span id="lastValue">‚Äî</span>
            </div>
          </div>
          <div class="status">
            <span class="pill" id="sendState">–ì–æ—Ç–æ–≤</span>
          </div>
        </div>

        <button class="btn" id="rollBtn">
          <span class="spark"></span>
          –ë—Ä–æ—Å–∏—Ç—å –∫—É–±–∏–∫
        </button>

        <div class="panel">
          <div class="label">–ü–æ–¥—Å–∫–∞–∑–∫–∞</div>
          <div class="hint">
            <span>–§—Ä–æ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ —á–µ—Ä–µ–∑ <code>WebApp.sendData</code>.</span>
            <span>–ë–æ—Ç –¥–µ–ª–∞–µ—Ç <code>sendDice</code> –≤ –Ω—É–∂–Ω—ã–π —á–∞—Ç.</span>
          </div>
        </div>
      </div>

      <div class="footer">
        <span id="userText">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ‚Äî</span>
        <a class="link" href="#" id="closeLink">–ó–∞–∫—Ä—ã—Ç—å</a>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;

    const envText = document.getElementById("envText");
    const userText = document.getElementById("userText");
    const rollBtn = document.getElementById("rollBtn");
    const lastValue = document.getElementById("lastValue");
    const sendState = document.getElementById("sendState");
    const closeLink = document.getElementById("closeLink");

    // UX helpers
    function setState(text, isBusy=false){
      sendState.textContent = text;
      rollBtn.disabled = isBusy;
    }

    // Telegram init
    if (tg) {
      tg.ready();

      // –ë–µ–π–¥–∂ –æ–∫—Ä—É–∂–µ–Ω–∏—è
      envText.textContent = "Telegram";

      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
      const u = tg.initDataUnsafe?.user;
      if (u) {
        const name = [u.first_name, u.last_name].filter(Boolean).join(" ");
        userText.textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${name}${u.username ? " (@" + u.username + ")" : ""}`;
      } else {
        userText.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: (–Ω–µ –ø–µ—Ä–µ–¥–∞–Ω)";
      }

      closeLink.onclick = (e) => {
        e.preventDefault();
        tg.close();
      };
    } else {
      envText.textContent = "Browser";
      userText.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: (–æ—Ç–∫—Ä—ã—Ç–æ –Ω–µ –≤ Telegram)";
      closeLink.onclick = (e) => {
        e.preventDefault();
        alert("–û—Ç–∫—Ä–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –±–æ—Ç–∞ (Mini App), —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–æ sendData().");
      };
    }

    // ‚Äú–ë—Ä–æ—Å–æ–∫‚Äù
    rollBtn.onclick = () => {
      if (!tg) return alert("–û—Ç–∫—Ä–æ–π –≤ Telegram Mini App.");

      // UI: –¥–µ–ª–∞–µ–º –≤–∏–¥, —á—Ç–æ ‚Äú–∫—Ä—É—Ç–∏–º‚Äù
      setState("–û—Ç–ø—Ä–∞–≤–ª—è—é‚Ä¶", true);
      lastValue.textContent = "‚Ä¶";

      const payload = {
        action: "roll",
        ts: Date.now()
      };

      // –û—Ç–ø—Ä–∞–≤–∫–∞ –±–æ—Ç—É (–±–æ—Ç –¥–∞–ª—å—à–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç üé≤ –≤ —á–∞—Ç)
      tg.sendData(JSON.stringify(payload));

      // –í–∞–∂–Ω–æ: sendData —á–∞—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç WebView ‚Äî –ø–æ—ç—Ç–æ–º—É UI –Ω–∏–∂–µ –º–æ–∂–µ—Ç –Ω–µ —É—Å–ø–µ—Ç—å –ø–æ–∫–∞–∑–∞—Ç—å.
      // –ù–æ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ/–Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞—Ö –≤–∏–¥–Ω–æ.
      setTimeout(() => setState("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", false), 400);
      setTimeout(() => setState("–ì–æ—Ç–æ–≤", false), 1200);
    };
  </script>
</body>
</html>
